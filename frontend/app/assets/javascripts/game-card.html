<link rel="import" href="/assets/javascripts/bower_components/polymer/polymer.html">
<polymer-element name="game-card" attributes="gameJson isNew isLive" hidden>

    <template>
        <style scoped>
        </style>
        <article class="game {{ {isNew: isNew =='true', isLive: isLive == 'true'} | tokenList}}" style="background-image:url('/assets/maps/{{game.map}}.jpg')">
            <div class="w">
                <header>
                    <h2>
                        <template if="{{game.id}}">
                            <a href="/game/{{game.id}}/">{{game.mode}} @ {{game.map}} {{game.when}}</a>
                        </template>
                        <template if="{{!game.id}}">
                            <a>{{game.mode}} @ {{game.map}} {{game.when}}</a>
                        </template>
                        <template if="{{game.demo}}">
                            <a class="demo-link" href="/demos/{{game.demo}}.dmo">demo</a>
                        </template>
                        <template if="{{game.now}}">
                            <a class="server-link" href="assaultcube://{{game.now.server.canonicalName || game.now.server.server}}">on {{game.now.server.shortName}}</a>
                            <p class="time-remain">
                            <template if="{{game.minRemain == '0'}}">game finished</template>
                            <template if="{{game.minRemain == '1'}}">1 minute remains</template>
                            <template if="{{game.minRemain > 1}}">{{game.minRemain}} minutes remain</template>
                            </p>
                        </template>
                    </h2>
                </header>
                <div class="teams">
                    <template repeat="{{team in game.teams}}">
                    <div class="{{team.name}} team">
                        <div class="team-header">
                            <h3>
                                <img src="/assets/{{team.name | toLowerCase}}.png"/>
                            </h3>
                            <div class="result">
                                <template if="{{game.hasFlags}}">
                                    <span class="score">{{team.flags}}</span>
                                    <span class="subscore">{{team.frags}}</span>
                                </template>
                                <template if="{{!game.hasFlags}}">
                                    <span class="score">{{team.frags}}</span>
                                </template>
                            </div>
                        </div>
                        <div class="players">
                            <ol>
                            <template repeat="{{player in team.players}}">
                                <li>
                                <template if="{{game.hasFlags}}">
                                <span class="score flags">{{player.flags}}</span>
                                <span class="subscore frags">{{player.frags}}</span>
                                </template>
                                <template if="{{!game.hasFlags}}">
                                <span class="score frags">{{player.frags}}</span>
                                </template>
                                <span class="name">
                                    <template if="{{player.user}}">
                                        <a href="/player/{{player.user}}/">{{player.name}}</a>
                                    </template>
                                    <template if="{{!player.user}}">
                                        <span>{{player.name}}</span>
                                    </template>
                                </span>
                                    </li>
                                </template>
                                </ol>
                          </div>
                        </div>
                    </template>
                </div>

                <template if="{{game.spectators}}">
                    <style scoped>
                        .spectators {
                            font-size:0.8em;
                        }
                        ul {
                            list-style-type: none;
                            width:auto;
                            margin:0;
                            padding:0;
                            margin-left:auto;
                            margin-right:auto;
                            display:flex;
                            justify-content: center;
                            flex-wrap: wrap;
                        }
                        li {
                            display:inline-block;
                            margin:0 0.2em;
                            padding:0;
                        }
                        h4 {
                            text-align: center;
                            margin-bottom:0;
                        }
                    </style>
                    <div class="spectators">

                        <h4>Spectators:</h4>
                        <ul>
                            <template repeat="{{spectator in game.spectators}}">
                                <li>
                                    <template if="{{spectator.user}}">
                                        <a href="/player/{{spectator.user}}/">{{spectator.name}}</a>
                                    </template>
                                    <template if="{{!spectator.user}}">
                                        <span>{{spectator.name}}</span>
                                    </template>
                                </li>
                            </template>
                        </ul>
                    </div>
                </template>
            </div>
        </article>
    </template>

    <script>
        Polymer("game-card", {
            gameJsonChanged: function(_, newValue) {
                var game = JSON.parse(newValue);
                if ( "teams" in game ) {
                    var tms = game.teams;
                    game.teams = tms.filter(function(x) {
                        return x.name == "RVSF" || x.name == "CLA";
                    });
                    var spectators = [];
                    tms.filter(function(x) {
                        if (!(x.name == "RVSF" || x.name == "CLA")) {
                            x.players.forEach(function(p) {
                                spectators.push(p);
                            })
                        }
                    });
                    if ( spectators.length ) {
                        game.spectators = spectators;
                    }  else {
                        game.spectators = null;
                    }
                }
                this.game = game;
            },
            toLowerCase: function(value) {
                return value.toLowerCase();
            }
        });
    </script>

</polymer-element>