<link rel="import" href="/assets/javascripts/bower_components/polymer/polymer.html">
<polymer-element name="live-games" attributes="initialJson liveUrl">

    <template>
        <template repeat="{{game in games}}">
            <template if="{{game.object.reasonablyActive}}">
                <game-card gameJson="{{game.json}}" isLive="true"></game-card>
            </template>
        </template>
    </template>

    <script>
        Polymer("live-games", {
            initialJsonChanged: function(_, newValue) {
                var newGames = JSON.parse(newValue).map(function(str) {
                    return {json: str, object: JSON.parse(str)};
                });
                this.games = newGames;
            },
            onMessage: function(msg) {
                var newJson = msg.data;
                var newObject = JSON.parse(newJson);
                var gamesMap = {};
                this.games.forEach(function(game) {
                    gamesMap[game.object.now.server.server] = game;
                });
                gamesMap[newObject.now.server.server] = { json: newJson, object: newObject };
                var newGames = Object.keys(gamesMap).map(function(k) {
                    return gamesMap[k];
                });
                this.games = newGames;
            },
            onClose: function() {
                setTimeout(this.liveUrlChanged.bind(this), 5000);
            },
            liveUrlChanged: function() {
                this.websocket = new WebSocket(this.liveUrl);
                this.websocket.onmessage = this.onMessage.bind(this);
                this.websocket.onclose = this.onClose.bind(this);
            }
        });
    </script>

</polymer-element>