<polymer-element name="live-games" attributes="initialJson liveUrl">

    <template>
        <template repeat="{{game in games}}">
            <template if="{{game.object.reasonablyActive}}">
                <game-card gameJson="{{game.json}}" isLive="true">&nbsp;</game-card>
            </template>
        </template>
    </template>

    <script>
        Polymer("live-games", {
            initialJsonChanged: function(_, newValue) {
                this.games = JSON.parse(newValue).map(function(str) {
                    return {json: str, object: JSON.parse(str)};
                });
            },

            liveUrlChanged: function() {
                this.websocket = new WebSocket(this.liveUrl);
                var ctx = this;
                this.websocket.onmessage = function(msg) {
                    var newJson = msg.data;
                    var newObject = JSON.parse(newJson);
                    ctx.games = ctx.games.slice().map(function(current) {
                        if ( current.object.now.server.server == newObject.now.server.server ) {
                            return { json: newJson, object: newObject };;
                        } else {
                            return current;
                        }
                    });
                };
                this.websocket.onerror = function() {
                    var meh = this;
                    setTimeout(function() {
                        var onm = meh.websocket.onmessage;
                        var one = meh.websocket.onerror;
                        meh.websocket = new WebSocket(meh.liveUrl);
                        meh.websocket.onmessage = onm;
                        meh.websocket.onerror = one;
                        meh.websocket.onclose = one;
                    }, 2000);
                }
                this.websocket.onclose = this.websocket.onerror;
            }
        });
    </script>

</polymer-element>