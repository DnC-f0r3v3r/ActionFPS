<link rel="import" href="/assets/javascripts/bower_components/polymer/polymer.html">
<polymer-element name="server-view" attributes="socketUrl servers">
    <template>
        <style scoped>
            .server-items, .teams-items, .players-items, .team-players, .empty-servers {
                list-style-type: none;
                margin:0;
                padding:0;
            }
            header {
                display:flex;
            }
            a.server-server {
                color:wheat;
                text-decoration: none;
            }
            .server-server, .modemap, .remain {
                flex:1;
            }
            .team-item {
                display:flex;

            }
            .team-item > * {
                flex:1;
            }
            .team-name {
                max-width:3em;
            }
            .team-score {
                max-width:4em;
            }
            .team-players li {
                display:inline-block;
                width:12em;
            }
            .empty-servers li {
                display:inline-block;
                margin-right:0.4em;
            }
        </style>
        <h3>Active servers</h3>
        <ol class="server-items">
            <template repeat="{{ server in serversData }}">
                <template if="{{server.game}}">
                    <li class="server-item">
                        <header>
                            <a class="server-server" href="assaultcube://{{server.server}}">{{server.connectName}}</a>
                            <span class="modemap">{{server.game.mode}} @ {{server.game.map}}</span>
                            <span class="remain">{{server.game.minRemain}} minutes remain</span>
                        </header>
                        <template if="{{server.game.teams}}">
                            <ol class="teams-items">
                                <template repeat="{{ team in teams(server.game.teams) }}">
                                    <li class="team-item">
                                        <span class="team-name">{{team}}:</span>
                                        <template if="{{server.game.teams[team].flags>=0}}">
                                            <span class="team-score">{{server.game.teams[team].flags}} ({{server.game.teams[team].frags}})</span>
                                        </template>
                                        <template if="{{!(server.game.teams[team].flags>=0)}}">
                                            <span class="team-score">{{server.game.teams[team].frags}}</span>
                                        </template>
                                        <ul class="team-players">
                                            <template repeat="{{ player in server.game.teams[team].players }}">
                                                <li>
                                                    <template if="{{server.game.teams[team].flags}}">
                                                        {{player.name}}: {{player.flags}} ({{player.frags}})
                                                    </template>
                                                    <template if="{{!server.game.teams[team].flags}}">
                                                        {{player.name}}: {{player.frags}}
                                                    </template>
                                                </li>
                                            </template>
                                        </ul>
                                    </li>
                                </template>
                            </ol>
                        </template>
                        <template if="{{server.game.players}}">
                            <ol class="players-items">
                                <template repeat="{{ player in server.game.players }}">
                                    <li class="player-item">
                                        <template if="{{player.flags >= 0}}">
                                            {{name}} ({{player.flags}}, {{player.frags}})
                                        </template>
                                        <template if="{{!(player.flags >= 0)}}">
                                            {{name}} ({{player.frags}})
                                        </template>
                                    </li>
                                </template>
                            </ol>
                        </template>
                    </li>
                </template>
            </template>
        </ol>
        <h3>Empty servers</h3>
        <ol class="empty-servers">
            <template repeat="{{ server in serversData }}">
                <template if="{{!server.game}}">
                    <li class="server-item">
                        <a class="server-server" href="assaultcube://{{server.server}}">{{server.connectName}}</a>
                    </li>
                </template>
            </template>
        </ol>
    </template>
    <script>
        Polymer("server-view", {
            serversMap: {},
            serversMapChanged: function() {
                this.serversData = [];
                for ( var sn in this.serversMap ) {
                    this.serversData.push(this.serversMap[sn]);
                }
                this.serversData.sort(function(a, b) {
                    if ( a.game && b.game ) {
                        return a.game.numClients < b.game.numClients ? 1 : -1;
                    } else if (a.game ) {
                        return -1;
                    } else if (b.game) { return 1;}
                    else { return 0;}
                })
            },
            serversChanged: function() {
                this.serversMap = JSON.parse(this.servers);
            },
            keys: function(o) {
                return Object.keys(o);
            },
            teams: function(o) {
                if ( "RVSF" in o ) {
                    return ['CLA', 'RVSF'];
                };
                return [];
            },
            socketUrlChanged: function() {
                this.websocket = new WebSocket(this.socketUrl);
                var ctx = this;
                this.websocket.onmessage = function(msg) {
                    var newServer = JSON.parse(msg.data);
                    ctx.serversMap[newServer.server] = newServer;
                    ctx.serversMapChanged();
                };
                this.websocket.onerror = function() {
                    var onm = this.websocket.onmessage;
                    var one = this.websocket.onerror;
                    this.websocket = new WebSocket(this.socketUrl);
                    this.websocket.onmessage = onm;
                    this.websocket.onerror = one;
                }
            }
        });
    </script>
</polymer-element>